<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reels - Ladies Meet 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      overflow: hidden;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: scale(1); }
      to { opacity: 0; transform: scale(0.95); }
    }
    .fade-in {
      animation: fadeIn 1s ease-out forwards;
    }
    .fade-out {
      animation: fadeOut 0.8s ease-in forwards;
    }
    .video-container {
      transition: all 0.8s ease-in-out;
    }
  </style>
</head>
<body class="bg-black">
  
  <!-- Main Video Display -->
  <div id="videoDisplay" class="h-screen w-screen flex items-center justify-center relative">
    <video 
      id="mainVideo"
      class="max-h-screen max-w-screen object-contain"
      autoplay 
      muted 
      loop 
      playsinline>
    </video>
    
    <!-- Info Overlay -->
    <div id="infoCard" class="absolute bottom-12 left-12 right-12 bg-gradient-to-r from-black/90 to-black/70 backdrop-blur-xl rounded-3xl p-10 text-white max-w-3xl shadow-2xl">
      <h2 id="personName" class="text-5xl font-bold mb-3"></h2>
      <p id="personUnit" class="text-2xl text-gray-300 mb-6"></p>
      <div id="futureReadySection" class="border-l-4 border-rose-500 pl-6 hidden">
        <p id="futureReadyText" class="text-xl italic leading-relaxed"></p>
      </div>
    </div>

    <!-- Progress Indicator -->
    <div class="absolute top-8 right-8 bg-black/70 backdrop-blur-md rounded-full px-8 py-4 text-white shadow-xl">
      <span id="currentIndex" class="font-bold text-3xl"></span>
      <span class="text-gray-300 text-2xl"> / </span>
      <span id="totalReels" class="text-gray-300 text-2xl"></span>
    </div>

    <!-- Header Badge -->
    <div class="absolute top-8 left-8 bg-gradient-to-r from-rose-500 to-pink-500 text-white px-6 py-3 rounded-full text-lg font-semibold shadow-xl">
      Ladies Meet 2025 ‚Ä¢ Reels
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading" class="fixed inset-0 bg-black flex items-center justify-center z-50">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-20 w-20 border-4 border-pink-200 border-t-pink-600 mb-4"></div>
      <p class="text-white text-2xl">Loading Reels...</p>
      <p class="text-gray-400 text-sm mt-2">Made with ‚ù§Ô∏è by Ordnance Fraternity</p>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty" class="hidden fixed inset-0 bg-gradient-to-br from-gray-900 to-black flex items-center justify-center">
    <div class="text-center">
      <div class="text-8xl mb-6">üé•</div>
      <p class="text-white text-3xl mb-2">No Reels Yet</p>
      <p class="text-gray-400 text-lg">Check back soon for amazing content!</p>
      <p class="text-gray-500 text-sm mt-8">Made with ‚ù§Ô∏è by Ordnance Fraternity</p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-lg py-3 text-center text-base text-gray-400">
    Made with ‚ù§Ô∏è by Ordnance Fraternity ‚Ä¢ Auto-rotating every 15 seconds
  </footer>

  <script>
    const SUPABASE_URL = "https://jlzqdefinnwoazsqlunf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsenFkZWZpbm53b2F6c3FsdW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTgwOTksImV4cCI6MjA3ODAzNDA5OX0.ZPfFVDqJgZkuhPGO9WNlYHKDwKgQ9SZoGjSIypgaDIE";
    
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const mainVideo = document.getElementById('mainVideo');
    const videoDisplay = document.getElementById('videoDisplay');
    const infoCard = document.getElementById('infoCard');
    const loading = document.getElementById('loading');
    const empty = document.getElementById('empty');
    const currentIndex = document.getElementById('currentIndex');
    const totalReels = document.getElementById('totalReels');
    const personName = document.getElementById('personName');
    const personUnit = document.getElementById('personUnit');
    const futureReadySection = document.getElementById('futureReadySection');
    const futureReadyText = document.getElementById('futureReadyText');

    let allReels = [];
    let currentReelIndex = 0;
    const REEL_DURATION = 15000; // 15 seconds per reel
    let rotationInterval;

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function showReel(index) {
      if (!allReels || allReels.length === 0) return;

      const reel = allReels[index];

      // Fade out current content
      videoDisplay.classList.add('fade-out');

      setTimeout(() => {
        // Update video source
        mainVideo.src = reel.reel_url;
        mainVideo.load();
        mainVideo.play().catch(err => console.log('Play error:', err));

        // Update info card
        personName.textContent = escapeHtml(reel.name);
        personUnit.textContent = escapeHtml(reel.unit || 'Unit not specified');

        if (reel.future_ready) {
          futureReadyText.textContent = `"${escapeHtml(reel.future_ready)}"`;
          futureReadySection.classList.remove('hidden');
        } else {
          futureReadySection.classList.add('hidden');
        }

        // Update progress
        currentIndex.textContent = index + 1;

        // Fade in new content
        videoDisplay.classList.remove('fade-out');
        videoDisplay.classList.add('fade-in');

        setTimeout(() => {
          videoDisplay.classList.remove('fade-in');
        }, 1000);
      }, 800);
    }

    function nextReel() {
      currentReelIndex = (currentReelIndex + 1) % allReels.length;
      showReel(currentReelIndex);
    }

    function startRotation() {
      // Clear any existing interval
      if (rotationInterval) {
        clearInterval(rotationInterval);
      }

      // Start auto-rotation
      rotationInterval = setInterval(nextReel, REEL_DURATION);
    }

    async function loadReels() {
      try {
        const { data, error } = await supabase
          .from('participants')
          .select('name, unit, reel_url, future_ready, created_at')
          .not('reel_url', 'is', null)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Supabase error:', error);
          throw error;
        }

        if (!data || data.length === 0) {
          loading.classList.add('hidden');
          empty.classList.remove('hidden');
          return;
        }

        allReels = data;
        totalReels.textContent = data.length;

        loading.classList.add('hidden');
        empty.classList.add('hidden');

        // Show first reel
        showReel(0);

        // Start rotation
        startRotation();

      } catch (err) {
        console.error('Error loading reels:', err);
        loading.classList.add('hidden');
        empty.classList.remove('hidden');
      }
    }

    // Handle video errors
    mainVideo.addEventListener('error', (e) => {
      console.error('Video error:', e);
      // Skip to next reel on error
      setTimeout(nextReel, 2000);
    });

    // Handle video end (in case loop fails)
    mainVideo.addEventListener('ended', () => {
      mainVideo.play().catch(err => console.log('Replay error:', err));
    });

    // Initial load
    loadReels();

    // Handle visibility change
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        if (allReels.length > 0) {
          mainVideo.play().catch(err => console.log('Play error:', err));
          startRotation();
        }
      } else {
        mainVideo.pause();
        if (rotationInterval) {
          clearInterval(rotationInterval);
        }
      }
    });
  </script>
</body>
</html>
