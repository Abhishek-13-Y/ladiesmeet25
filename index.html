<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monthly Interaction 2025 - Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .card-shadow { box-shadow: 0 8px 20px rgba(20, 184, 166, 0.1); }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(240,253,250,0.7));
      backdrop-filter: blur(10px);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-teal-50 via-cyan-50 to-emerald-50 font-sans text-gray-800">

  <div class="max-w-5xl mx-auto p-4">
    <!-- Header -->
    <header class="text-center mb-8 pt-6">
      <div class="inline-block px-6 py-2 rounded-full bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-semibold mb-3">
        Monthly Interaction 2025
      </div>
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-teal-600 to-cyan-600 mb-3">
        Participant Portal
      </h1>
      <p class="text-sm text-gray-600">Made with ‚ù§Ô∏è by Ordnance Fraternity</p>
      <p class="text-xs text-gray-400 mt-2">Share your vision & like others resolution</p>
    </header>

    <!-- Navigation -->
    <nav class="glass rounded-2xl p-4 mb-6 card-shadow">
      <div class="flex justify-center gap-4 flex-wrap">
        <button onclick="navigateTo('#register')" id="navRegister" class="px-6 py-3 rounded-xl font-semibold transition bg-white border-2 border-teal-200 hover:border-teal-400">
          üìù Register / Update
        </button>
        <button onclick="navigateTo('#resolutions')" id="navResolutions" class="px-6 py-3 rounded-xl font-semibold transition bg-white border-2 border-teal-200 hover:border-teal-400">
          üí≠ View Visions
        </button>
      </div>
    </nav>

    <!-- Main Content Container -->
    <main class="glass rounded-3xl p-6 card-shadow min-h-[500px]">

      <!-- REGISTRATION PAGE -->
      <section id="registerPage" class="hidden">
        <h2 class="text-3xl font-bold text-teal-700 mb-6 text-center">Registration Portal</h2>
        
        <div id="welcomeMessage" class="hidden mb-6 bg-gradient-to-r from-teal-50 to-cyan-50 border-2 border-teal-300 rounded-2xl p-6 text-center">
          <div class="text-5xl mb-3">üëã</div>
          <h3 class="text-2xl font-bold text-teal-700 mb-2">Welcome back, <span id="welcomeName"></span>!</h3>
          <p class="text-gray-600">Mobile: <span id="welcomeMobile" class="font-semibold text-teal-600"></span></p>
          <p class="text-sm text-gray-500 mt-2">Updates remaining: <span id="updatesRemaining" class="font-bold text-teal-600">3</span></p>
        </div>

        <div id="successMessage" class="hidden bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-2xl p-8 mb-6 text-center">
          <div class="text-7xl mb-4 animate-bounce">‚úÖ</div>
          <h3 class="text-3xl font-bold text-green-800 mb-3">Success!</h3>
          <p class="text-lg text-green-700">Your details have been saved.</p>
        </div>

        <form id="participantForm" class="space-y-5 max-w-2xl mx-auto">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Mobile Number</label>
            <div class="relative">
              <input id="mobile" type="tel" placeholder="Enter 10-digit mobile" maxlength="10" required 
                class="w-full p-4 pr-12 rounded-xl border-2 border-teal-200 focus:ring-2 focus:ring-teal-400 focus:border-teal-400 transition" />
              <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400">üì±</span>
            </div>
            <p id="mobileError" class="text-red-600 text-sm mt-1 hidden"></p>
          </div>

          <button type="button" id="checkBtn" class="w-full bg-gradient-to-r from-teal-500 to-cyan-500 text-white py-4 rounded-xl font-semibold hover:from-teal-600 hover:to-cyan-600 transition shadow-lg">
            Continue ‚Üí
          </button>

          <div id="formFields" class="space-y-5 hidden">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name</label>
              <input id="name" type="text" required class="w-full p-4 rounded-xl border-2 border-teal-200 focus:ring-2 focus:ring-teal-400 disabled:bg-gray-100" />
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Unit / Directorate</label>
              <input id="unit" type="text" required class="w-full p-4 rounded-xl border-2 border-teal-200 focus:ring-2 focus:ring-teal-400 disabled:bg-gray-100" />
            </div>
            
            <div class="bg-gradient-to-br from-teal-50 to-cyan-50 p-5 rounded-xl border-2 border-teal-200">
              <label class="block text-sm font-semibold text-teal-700 mb-2 flex items-center justify-between">
                <span>‚ú® Your Vision for 2026</span>
                <span id="charCount" class="text-xs text-gray-500">0 / 500</span>
              </label>
              <textarea id="futureReady" rows="4" maxlength="500" placeholder="Share your goals and vision..." 
                class="w-full p-4 rounded-xl border-2 border-teal-200 focus:ring-2 focus:ring-teal-400 resize-none" required></textarea>
              <p id="editWarning" class="text-sm mt-2 hidden"></p>
            </div>
            
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-5 rounded-xl border-2 border-purple-200">
              <label class="block text-sm font-semibold text-purple-700 mb-2">üì∏ Upload Selfie (Optional)</label>
              
              <div id="existingSelfiePreview" class="hidden mb-4">
                <div class="bg-white rounded-xl p-3 border-2 border-green-300">
                  <div class="flex items-center gap-3 mb-2">
                    <span class="text-green-600">‚úÖ</span>
                    <span class="text-sm font-semibold text-green-700">Selfie Already Uploaded</span>
                  </div>
                  <img id="existingSelfieImg" src="" alt="Current" class="w-32 h-32 object-cover rounded-lg" />
                </div>
              </div>

              <div id="newSelfiePreview" class="hidden mb-4">
                <div class="bg-white rounded-xl p-3 border-2 border-blue-300">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-semibold text-blue-700">Preview (Not saved)</span>
                    <button type="button" id="clearSelfieBtn" class="text-red-600 hover:text-red-800 text-sm font-semibold">‚úï Remove</button>
                  </div>
                  <img id="newSelfieImg" src="" alt="Preview" class="w-32 h-32 object-cover rounded-lg" />
                </div>
              </div>

              <input id="selfie" type="file" accept="image/jpeg,image/png,image/jpg" 
                class="w-full p-3 border-2 border-purple-200 rounded-xl bg-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-500 file:text-white file:font-semibold hover:file:bg-purple-600 file:cursor-pointer" />
              <p id="selfieError" class="text-red-600 text-sm mt-2 hidden"></p>
              <div class="text-xs text-purple-600 mt-2">
                <div>‚Ä¢ Max: 5MB ‚Ä¢ JPG, PNG</div>
              </div>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-4 rounded-xl font-bold text-lg hover:from-teal-700 hover:to-cyan-700 transition shadow-lg disabled:opacity-50">
              Submit ‚úì
            </button>
          </div>
        </form>
        
        <div id="status" class="mt-5 text-center text-sm font-medium"></div>
      </section>

      <!-- RESOLUTIONS PAGE -->
      <section id="resolutionsPage" class="hidden">
        <h2 class="text-3xl font-bold text-teal-700 mb-6 text-center">Community Visions 2026</h2>
        
        <div class="flex justify-between items-center gap-4 mb-6 flex-wrap">
          <input id="searchInput" type="search" placeholder="Search by name, unit, or vision..." 
            class="flex-1 min-w-[200px] p-3 rounded-xl border-2 border-teal-200 focus:ring-2 focus:ring-teal-400" />
          <button id="refreshBtn" class="px-4 py-3 rounded-xl bg-white border-2 border-teal-200 hover:border-teal-400 font-semibold">
            üîÑ Refresh
          </button>
          <div class="text-sm text-gray-600">Showing: <span id="countBadge" class="font-bold text-teal-600">0</span></div>
        </div>

        <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        
        <div id="emptyState" class="hidden text-center text-gray-500 py-12">
          <div class="text-6xl mb-4">üí≠</div>
          <p class="text-xl">No visions shared yet. Be the first!</p>
        </div>
      </section>

    </main>
  </div>

  <script>
    const SUPABASE_URL = "https://jlzqdefinnwoazsqlunf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsenFkZWZpbm53b2F6c3FsdW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTgwOTksImV4cCI6MjA3ODAzNDA5OX0.ZPfFVDqJgZkuhPGO9WNlYHKDwKgQ9SZoGjSIypgaDIE";
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    let existingRecord = null;
    let allVisions = [];

    function esc(s) {
      if (!s) return '';
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    }

    function shortName(n) {
      if (!n) return 'Anonymous';
      return n.split(' ')[0];
    }

    function navigateTo(hash) {
      window.location.hash = hash;
    }

    function handleRoute() {
      const hash = window.location.hash || '#register';
      document.getElementById('registerPage').classList.add('hidden');
      document.getElementById('resolutionsPage').classList.add('hidden');
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('bg-teal-500', 'text-white'));

      if (hash === '#resolutions') {
        document.getElementById('resolutionsPage').classList.remove('hidden');
        document.getElementById('navResolutions').classList.add('bg-teal-500', 'text-white');
        loadResolutions();
      } else {
        document.getElementById('registerPage').classList.remove('hidden');
        document.getElementById('navRegister').classList.add('bg-teal-500', 'text-white');
      }
    }

    window.addEventListener('hashchange', handleRoute);
    handleRoute();

    // REGISTRATION FUNCTIONS
    function validateMobile(mobile) {
      const err = document.getElementById("mobileError");
      if (!/^[0-9]{10}$/.test(mobile)) {
        err.textContent = "‚ö†Ô∏è Must be 10 digits";
        err.classList.remove("hidden");
        return false;
      }
      err.classList.add("hidden");
      return true;
    }

    function validateFile(file) {
      if (!file) return { valid: true };
      const maxSize = 5 * 1024 * 1024;
      const allowed = ['image/jpeg', 'image/png', 'image/jpg'];
      if (file.size > maxSize) return { valid: false, error: '‚ùå Max 5MB' };
      if (!allowed.includes(file.type)) return { valid: false, error: '‚ùå JPG/PNG only' };
      return { valid: true };
    }

    async function uploadFile(file, mobile) {
      if (!file) return null;
      const fileExt = file.name.split('.').pop();
      const fileName = `${mobile}_${Date.now()}.${fileExt}`;
      const filePath = `selfies/${fileName}`;

      const { error } = await supabase.storage
        .from('ladies-meet-2025')
        .upload(filePath, file, { cacheControl: '3600', upsert: true });

      if (error) throw error;

      const { data: urlData } = supabase.storage
        .from('ladies-meet-2025')
        .getPublicUrl(filePath);

      return urlData.publicUrl;
    }

    document.getElementById("checkBtn").addEventListener("click", async () => {
      const mobile = document.getElementById("mobile").value.trim();
      if (!validateMobile(mobile)) return;

      const checkBtn = document.getElementById("checkBtn");
      const statusDiv = document.getElementById("status");
      
      checkBtn.disabled = true;
      checkBtn.textContent = "Checking...";
      statusDiv.textContent = "‚è≥ Please wait...";

      try {
        const { data } = await supabase
          .from('participants')
          .select('*')
          .eq('mobile', mobile)
          .maybeSingle();

        if (data) {
          existingRecord = data;
          document.getElementById("welcomeName").textContent = data.name;
          document.getElementById("welcomeMobile").textContent = mobile;
          document.getElementById("updatesRemaining").textContent = Math.max(0, 3 - (data.edits || 0));
          document.getElementById("welcomeMessage").classList.remove("hidden");
          
          document.getElementById("name").value = data.name || '';
          document.getElementById("unit").value = data.unit || '';
          document.getElementById("futureReady").value = data.future_ready || '';
          document.getElementById("charCount").textContent = `${(data.future_ready || '').length} / 500`;
          
          document.getElementById("name").disabled = true;
          document.getElementById("unit").disabled = true;

          if (data.selfie_url) {
            document.getElementById("existingSelfieImg").src = data.selfie_url;
            document.getElementById("existingSelfiePreview").classList.remove("hidden");
          }

          if ((data.edits || 0) >= 3) {
            document.getElementById("editWarning").textContent = '‚ö†Ô∏è Maximum 3 updates reached. Editing disabled.';
            document.getElementById("editWarning").classList.remove("hidden");
            document.getElementById("futureReady").disabled = true;
            document.getElementById("submitBtn").disabled = true;
          } else {
            document.getElementById("editWarning").textContent = `‚ÑπÔ∏è ${3 - (data.edits || 0)} update(s) remaining`;
            document.getElementById("editWarning").classList.remove("hidden");
          }
        } else {
          existingRecord = null;
          document.getElementById("welcomeMessage").classList.add("hidden");
        }

        document.getElementById("formFields").classList.remove("hidden");
        document.getElementById("mobile").readOnly = true;
        checkBtn.classList.add("hidden");
        statusDiv.textContent = "";
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "‚ùå Error checking mobile";
      }
    });

    document.getElementById("futureReady").addEventListener("input", (e) => {
      document.getElementById("charCount").textContent = `${e.target.value.length} / 500`;
    });

    document.getElementById("participantForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      const statusDiv = document.getElementById("status");
      
      submitBtn.disabled = true;
      submitBtn.textContent = "‚è≥ Saving...";

      const mobile = document.getElementById("mobile").value.trim();
      const name = document.getElementById("name").value.trim();
      const unit = document.getElementById("unit").value.trim();
      const futureReady = document.getElementById("futureReady").value.trim();
      const selfieFile = document.getElementById("selfie").files[0];

      const validation = validateFile(selfieFile);
      if (!validation.valid) {
        document.getElementById("selfieError").textContent = validation.error;
        document.getElementById("selfieError").classList.remove("hidden");
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit ‚úì";
        return;
      }

      try {
        let selfieUrl = existingRecord?.selfie_url || null;
        if (selfieFile) {
          statusDiv.textContent = "üì§ Uploading...";
          selfieUrl = await uploadFile(selfieFile, mobile);
        }

        statusDiv.textContent = "üíæ Saving...";

        const participantData = {
          mobile,
          name,
          unit,
          future_ready: futureReady,
          selfie_url: selfieUrl,
          likes: existingRecord?.likes || 0,
          edits: existingRecord ? (existingRecord.edits || 0) + 1 : 0,
          created_at: existingRecord?.created_at || new Date().toISOString()
        };

        const { error } = await supabase
          .from('participants')
          .upsert(participantData, { onConflict: 'mobile' });

        if (error) throw error;

        document.getElementById("participantForm").classList.add("hidden");
        document.getElementById("welcomeMessage").classList.add("hidden");
        document.getElementById("successMessage").classList.remove("hidden");
        statusDiv.textContent = "";

        setTimeout(() => location.reload(), 3000);
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "‚ùå " + err.message;
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit ‚úì";
      }
    });

    document.getElementById("mobile").addEventListener("input", (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 10);
    });

    document.getElementById("clearSelfieBtn").addEventListener("click", () => {
      document.getElementById("selfie").value = '';
      document.getElementById("newSelfiePreview").classList.add("hidden");
    });

    document.getElementById("selfie").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const validation = validateFile(file);
        if (validation.valid) {
          document.getElementById("newSelfieImg").src = URL.createObjectURL(file);
          document.getElementById("newSelfiePreview").classList.remove("hidden");
        } else {
          document.getElementById("selfieError").textContent = validation.error;
          document.getElementById("selfieError").classList.remove("hidden");
        }
      }
    });

    // RESOLUTIONS FUNCTIONS
    async function loadResolutions() {
      try {
        const { data, error } = await supabase
          .from('participants')
          .select('*')
          .not('future_ready', 'is', null)
          .order('likes', { ascending: false })
          .order('created_at', { ascending: false })
          .limit(200);

        if (error) throw error;
        allVisions = data || [];
        renderVisions(allVisions);
      } catch (err) {
        console.error(err);
        document.getElementById("cardsContainer").innerHTML = '<div class="text-red-600 text-center p-4">Failed to load</div>';
      }
    }

    function renderVisions(list) {
      const container = document.getElementById("cardsContainer");
      const empty = document.getElementById("emptyState");
      const badge = document.getElementById("countBadge");

      if (!list || !list.length) {
        container.innerHTML = '';
        empty.classList.remove("hidden");
        badge.textContent = '0';
        return;
      }

      empty.classList.add("hidden");
      badge.textContent = list.length;
      container.innerHTML = '';

      list.forEach(v => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl p-5 shadow-sm border-2 border-teal-100 hover:border-teal-300 transition card-shadow';
        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <div class="text-xs text-gray-500 mb-1">${esc(v.unit || 'Unit not specified')}</div>
              <div class="font-bold text-xl text-teal-700">${esc(shortName(v.name))}</div>
            </div>
            <div class="text-xs text-gray-400">${new Date(v.created_at).toLocaleDateString()}</div>
          </div>
          <div class="text-gray-700 mb-4 text-sm leading-relaxed" style="white-space:pre-wrap;">${esc(v.future_ready)}</div>
          <div class="flex items-center justify-between pt-3 border-t border-teal-100">
            <button data-id="${v.id}" class="like-btn inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-teal-100 to-cyan-100 hover:from-teal-200 hover:to-cyan-200 font-semibold transition">
              ‚ù§Ô∏è <span class="likes-count text-teal-700">${v.likes || 0}</span>
            </button>
            <div class="text-xs text-gray-500">Edits: ${v.edits || 0}/3</div>
          </div>
        `;
        container.appendChild(card);

        card.querySelector('.like-btn').addEventListener('click', async (ev) => {
          const btn = ev.currentTarget;
          const id = btn.dataset.id;
          const span = btn.querySelector('.likes-count');
          const old = parseInt(span.textContent || '0');

          btn.disabled = true;
          span.textContent = old + 1;

          try {
            const { data: participant } = await supabase
              .from('participants')
              .select('likes')
              .eq('id', id)
              .single();

            const newLikes = (participant?.likes || 0) + 1;

            const { error } = await supabase
              .from('participants')
              .update({ likes: newLikes })
              .eq('id', id);

            if (error) throw error;
            span.textContent = newLikes;
          } catch (err) {
            console.error(err);
            span.textContent = old;
            alert('Failed to like');
          } finally {
            btn.disabled = false;
          }
        });
      });
    }

    document.getElementById("searchInput").addEventListener("input", (e) => {
      const term = e.target.value.toLowerCase().trim();
      if (!term) {
        renderVisions(allVisions);
        return;
      }
      const filtered = allVisions.filter(v => 
        (v.name || '').toLowerCase().includes(term) ||
        (v.unit || '').toLowerCase().includes(term) ||
        (v.future_ready || '').toLowerCase().includes(term)
      );
      renderVisions(filtered);
    });

    document.getElementById("refreshBtn").addEventListener("click", loadResolutions);
  </script>
</body>
</html>