<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resolution App ‚Äî Ladies Meet 2025</title>

  <!-- Tailwind (CDN for quick deploy; ok for event use) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* tiny overrides for nicer card shadows */
    .card-shadow { box-shadow: 0 8px 20px rgba(60,60,90,0.06); }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(250,250,255,0.6));
      backdrop-filter: blur(6px);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-[#F6FFFA] via-[#F7F5FF] to-[#FFF7F3] font-sans text-gray-800 p-4">

  <div class="max-w-4xl mx-auto">
    <header class="text-center mb-8">
      <div class="inline-block px-4 py-1 rounded-full bg-gradient-to-r from-[#C5F5E1] to-[#E9D8FD] text-[#374151] font-semibold">Ladies Meet 2025</div>
      <h1 class="mt-4 text-3xl md:text-4xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-[#6EE7B7] to-[#C7B8FF]">
        Resolution Portal ‚Äî 2026
      </h1>
      <p class="mt-2 text-sm text-gray-600">Add / Edit your resolution or view & like others' resolutions</p>
    </header>

    <!-- main card -->
    <main class="glass rounded-3xl p-6 card-shadow">

      <!-- Landing / controls -->
      <section id="landingView" class="text-center space-y-4">
        <p class="text-sm text-gray-600">Choose an action</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <button id="btnAdd" class="py-4 px-6 rounded-2xl bg-white border border-[#E9E3FF] hover:shadow-lg transition text-lg font-semibold">
            ‚úçÔ∏è Add / Edit My Resolution
          </button>

          <button id="btnView" class="py-4 px-6 rounded-2xl bg-white border border-[#DFF6EE] hover:shadow-lg transition text-lg font-semibold">
            üíñ View All Resolutions
          </button>
        </div>

        <div class="mt-6 text-xs text-gray-500">
          Tip: Enter mobile to edit if your entry exists. Edits to the resolution are limited to <strong>3</strong> times.
        </div>
      </section>

      <!-- Add/Edit form -->
      <section id="formView" class="hidden mt-6">
        <div class="max-w-2xl mx-auto space-y-4">
          <div id="mobileStep" class="space-y-2">
            <label class="text-sm font-medium">Enter your mobile number</label>
            <div class="flex gap-2">
              <input id="mobileInput" type="tel" maxlength="10" placeholder="10-digit mobile" class="flex-1 p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#CDEFD3]" />
              <button id="mobileCheckBtn" class="px-4 rounded-xl bg-[#C5F5E1] hover:bg-[#A8EBC0] font-semibold">Check</button>
            </div>
            <p id="mobileError" class="text-sm text-red-600 hidden"></p>
          </div>

          <form id="resolutionForm" class="space-y-4 hidden">
            <!-- read-only name/unit when editing; editable when new -->
            <div>
              <label class="text-sm font-medium">Full name</label>
              <input id="nameInput" type="text" class="w-full p-3 rounded-xl border border-gray-200 disabled:bg-gray-50" />
            </div>

            <div>
              <label class="text-sm font-medium">Unit / Directorate</label>
              <input id="unitInput" type="text" class="w-full p-3 rounded-xl border border-gray-200 disabled:bg-gray-50" />
            </div>

            <div>
              <label class="text-sm font-medium flex items-center justify-between">
                <span>Resolution (max 500 characters)</span>
                <span id="charCount" class="text-xs text-gray-500">0 / 500</span>
              </label>
              <textarea id="resolutionInput" rows="5" maxlength="500" class="w-full p-3 rounded-xl border border-gray-200"></textarea>
              <p id="editWarning" class="text-sm text-orange-600 hidden mt-1"></p>
            </div>

            <div class="flex gap-2">
              <button id="submitResolutionBtn" type="button" class="flex-1 py-3 rounded-xl bg-[#C7B8FF] hover:bg-[#B39CFF] font-semibold">Submit</button>
              <button id="cancelFormBtn" type="button" class="flex-1 py-3 rounded-xl bg-white border border-gray-200 hover:shadow">Cancel</button>
            </div>
            <p id="formStatus" class="text-sm text-center text-gray-600"></p>
          </form>
        </div>
      </section>

      <!-- View resolutions -->
      <section id="listView" class="hidden mt-6">
        <div class="flex justify-between items-center mb-4">
          <div class="flex gap-2">
            <input id="searchInput" type="search" placeholder="Search name / unit / resolution..." class="p-3 rounded-xl border border-gray-200 w-full md:w-96" />
            <button id="refreshBtn" class="px-4 py-3 rounded-xl bg-white border border-gray-200 hover:shadow">Refresh</button>
          </div>
          <div class="text-sm text-gray-500">Showing <span id="countBadge">0</span> resolutions</div>
        </div>

        <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

        <div id="emptyState" class="hidden text-center text-gray-500 py-8">
          No resolutions yet. Be the first ‚ú®
        </div>
      </section>

    </main>
  </div>

  <script>
    // ----------------------------
    // Replace these with your SUPABASE values
    // ----------------------------
    const SUPABASE_URL = "https://jlzqdefinnwoazsqlunf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsenFkZWZpbm53b2F6c3FsdW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTgwOTksImV4cCI6MjA3ODAzNDA5OX0.ZPfFVDqJgZkuhPGO9WNlYHKDwKgQ9SZoGjSIypgaDIE";
    // ----------------------------

    // Initialize supabase client (from CDN)
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI references
    const landingView = document.getElementById('landingView');
    const formView = document.getElementById('formView');
    const listView = document.getElementById('listView');

    const btnAdd = document.getElementById('btnAdd');
    const btnView = document.getElementById('btnView');

    const mobileInput = document.getElementById('mobileInput');
    const mobileCheckBtn = document.getElementById('mobileCheckBtn');
    const mobileError = document.getElementById('mobileError');

    const resolutionForm = document.getElementById('resolutionForm');
    const nameInput = document.getElementById('nameInput');
    const unitInput = document.getElementById('unitInput');
    const resolutionInput = document.getElementById('resolutionInput');
    const charCount = document.getElementById('charCount');
    const editWarning = document.getElementById('editWarning');
    const submitResolutionBtn = document.getElementById('submitResolutionBtn');
    const cancelFormBtn = document.getElementById('cancelFormBtn');
    const formStatus = document.getElementById('formStatus');

    const searchInput = document.getElementById('searchInput');
    const refreshBtn = document.getElementById('refreshBtn');
    const cardsContainer = document.getElementById('cardsContainer');
    const countBadge = document.getElementById('countBadge');
    const emptyState = document.getElementById('emptyState');

    // State
    let currentRecord = null;   // holds existing resolution row if present
    let allResolutions = [];    // cached list

    // Helpers
    function showLanding() {
      landingView.classList.remove('hidden');
      formView.classList.add('hidden');
      listView.classList.add('hidden');
    }
    function showForm() {
      landingView.classList.add('hidden');
      formView.classList.remove('hidden');
      listView.classList.add('hidden');
      // reset form UI
      resolutionForm.classList.add('hidden'); // until mobile check
      mobileInput.value = '';
      nameInput.value = '';
      unitInput.value = '';
      resolutionInput.value = '';
      charCount.textContent = '0 / 500';
      editWarning.classList.add('hidden');
      mobileError.classList.add('hidden');
      formStatus.textContent = '';
      currentRecord = null;
    }
    function showList() {
      landingView.classList.add('hidden');
      formView.classList.add('hidden');
      listView.classList.remove('hidden');
    }

    // Validate mobile
    function validateMobile(num) {
      return /^[6-9]\d{9}$/.test(num);
    }

    // Format display name for privacy if needed (optional)
    function shortName(n) {
      if (!n) return 'Anonymous';
      const parts = n.split(' ');
      return parts[0]; // simple: show first name
    }

    // Render resolutions cards
    function renderCards(list) {
      cardsContainer.innerHTML = '';
      if (!list || list.length === 0) {
        emptyState.classList.remove('hidden');
        countBadge.textContent = '0';
        return;
      }
      emptyState.classList.add('hidden');
      countBadge.textContent = String(list.length);
      list.forEach((r) => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex flex-col justify-between card-shadow';
        card.innerHTML = `
          <div>
            <div class="flex items-center justify-between mb-2">
              <div>
                <div class="text-sm text-gray-500">${escapeHtml(r.unit || '')}</div>
                <div class="font-semibold text-lg">${escapeHtml(shortName(r.name))}</div>
              </div>
              <div class="text-xs text-gray-400">${new Date(r.created_at).toLocaleString()}</div>
            </div>
            <div class="text-gray-700 mb-4" style="white-space:pre-wrap;">${escapeHtml(r.resolution)}</div>
          </div>
          <div class="flex items-center justify-between mt-2">
            <button data-id="${r.id}" class="like-btn inline-flex items-center gap-2 px-3 py-2 rounded-full bg-gradient-to-r from-[#FFEEDD] to-[#FDEFD6] text-sm font-semibold">
              ‚ù§Ô∏è <span class="likes-count">${r.likes || 0}</span>
            </button>
            <div class="text-xs text-gray-500">Edits: ${r.edits || 0}</div>
          </div>
        `;
        cardsContainer.appendChild(card);

        // attach like handler
        card.querySelector('.like-btn').addEventListener('click', async (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          // optimistic UI: increment UI count immediately
          const span = ev.currentTarget.querySelector('.likes-count');
          const old = parseInt(span.textContent || '0', 10);
          span.textContent = old + 1;
          try {
            const res = await supabase.rpc('like_resolution', id);
            if (res.error) {
              // revert on error
              span.textContent = old;
              console.error(res.error);
            } else {
              span.textContent = res; // server returned new likes
            }
          } catch (err) {
            span.textContent = old;
            console.error(err);
          }
        });
      });
    }

    // escape HTML helper
    function escapeHtml(s) {
      if (s == null) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // FETCH all resolutions (cache)
    async function loadResolutions() {
      try {
        const { data, error } = await supabase
          .from('resolutions')
          .select('*')
          .order('likes', { ascending: false })
          .limit(200);
        if (error) throw error;
        allResolutions = data || [];
        renderCards(allResolutions);
      } catch (err) {
        console.error('Failed to load resolutions:', err);
        cardsContainer.innerHTML = '<div class="text-center text-red-600 p-4">Failed to load.</div>';
      }
    }

    // Search filter
    function applySearch() {
      const term = (searchInput.value || '').toLowerCase().trim();
      if (!term) {
        renderCards(allResolutions);
        return;
      }
      const filtered = allResolutions.filter(r => {
        return (r.name||'').toLowerCase().includes(term)
          || (r.unit||'').toLowerCase().includes(term)
          || (r.resolution||'').toLowerCase().includes(term);
      });
      renderCards(filtered);
    }

    // MOBILE CHECK: called when user enters mobile and clicks Check
    mobileCheckBtn.addEventListener('click', async () => {
      const mobile = mobileInput.value.trim();
      mobileError.classList.add('hidden');
      if (!validateMobile(mobile)) {
        mobileError.textContent = 'Enter a valid 10-digit mobile number starting with 6-9';
        mobileError.classList.remove('hidden');
        return;
      }

      // show form
      resolutionForm.classList.add('hidden');
      formStatus.textContent = 'Checking‚Ä¶';
      try {
        const { data, error } = await supabase
          .from('resolutions')
          .select('*')
          .eq('mobile', mobile)
          .single();
        // if record exists
        if (data) {
          currentRecord = data;
          nameInput.value = data.name || '';
          unitInput.value = data.unit || '';
          resolutionInput.value = data.resolution || '';
          charCount.textContent = `${(resolutionInput.value||'').length} / 500`;

          // set readonly name/unit
          nameInput.disabled = true;
          unitInput.disabled = true;

          // check edits
          if ((data.edits || 0) >= 3) {
            editWarning.textContent = 'You have reached the maximum of 3 edits for your resolution. Editing is disabled.';
            editWarning.classList.remove('hidden');
            resolutionInput.disabled = true;
            submitResolutionBtn.disabled = true;
          } else {
            editWarning.classList.add('hidden');
            resolutionInput.disabled = false;
            submitResolutionBtn.disabled = false;
          }
        } else {
          // Not found -> new entry
          currentRecord = null;
          nameInput.value = '';
          unitInput.value = '';
          resolutionInput.value = '';
          nameInput.disabled = false;
          unitInput.disabled = false;
          resolutionInput.disabled = false;
          editWarning.classList.add('hidden');
          submitResolutionBtn.disabled = false;
        }
        resolutionForm.classList.remove('hidden');
        formStatus.textContent = '';
      } catch (err) {
        // single returns error when not found ‚Äî treat as new
        console.log('Check result (possible no record):', err);
        currentRecord = null;
        resolutionForm.classList.remove('hidden');
        nameInput.disabled = false;
        unitInput.disabled = false;
        resolutionInput.disabled = false;
        editWarning.classList.add('hidden');
        submitResolutionBtn.disabled = false;
        formStatus.textContent = '';
      }
    });

    // count chars
    resolutionInput.addEventListener('input', () => {
      charCount.textContent = `${resolutionInput.value.length} / 500`;
    });

    // submit resolution (calls submit_resolution RPC)
    submitResolutionBtn.addEventListener('click', async () => {
      const mobile = mobileInput.value.trim();
      const name = nameInput.value.trim();
      const unit = unitInput.value.trim();
      const resolutionText = resolutionInput.value.trim();

      if (!validateMobile(mobile)) {
        formStatus.textContent = 'Enter a valid mobile number.';
        formStatus.className = 'text-sm text-red-600 mt-2 text-center';
        return;
      }
      if (!name) {
        formStatus.textContent = 'Name is required.';
        formStatus.className = 'text-sm text-red-600 mt-2 text-center';
        return;
      }
      if (!resolutionText || resolutionText.length < 5) {
        formStatus.textContent = 'Please write a short resolution (min 5 characters).';
        formStatus.className = 'text-sm text-red-600 mt-2 text-center';
        return;
      }

      // call RPC to insert/update with edit-limit enforced in DB
      submitResolutionBtn.disabled = true;
      submitResolutionBtn.textContent = 'Saving‚Ä¶';
      formStatus.textContent = 'Saving‚Ä¶';
      try {
        const { data, error } = await supabase.rpc('submit_resolution', {
          p_mobile: mobile,
          p_name: name,
          p_unit: unit,
          p_resolution: resolutionText
        });

        if (error) throw error;

        // RPC returns jsonb { ok:true/false, msg: "...", id: "..." }
        // check result
        if (data && data.ok === false) {
          formStatus.textContent = '‚ùå ' + (data.msg || 'Failed to save');
          formStatus.className = 'text-sm text-red-600 mt-2 text-center';
        } else {
          formStatus.textContent = '‚úÖ Saved! Redirecting to view...';
          formStatus.className = 'text-sm text-green-600 mt-2 text-center';
          // refresh list and show view
          await loadResolutions();
          setTimeout(() => showList(), 800);
        }
      } catch (err) {
        console.error('submit error', err);
        formStatus.textContent = '‚ùå ' + (err.message || 'Failed to save');
        formStatus.className = 'text-sm text-red-600 mt-2 text-center';
      } finally {
        submitResolutionBtn.disabled = false;
        submitResolutionBtn.textContent = 'Submit';
      }
    });

    // cancel
    cancelFormBtn.addEventListener('click', () => {
      showLanding();
    });

    // view/resolutions handlers
    btnAdd.addEventListener('click', () => {
      showForm();
    });
    btnView.addEventListener('click', async () => {
      showList();
      await loadResolutions();
    });

    // search / refresh
    searchInput.addEventListener('input', () => applySearch());
    refreshBtn.addEventListener('click', () => loadResolutions());

    // initial landing
    showLanding();

    // auto-refresh list occasionally (optional)
    // setInterval(() => { if (!listView.classList.contains('hidden')) loadResolutions(); }, 30000);
  </script>
</body>
</html>
