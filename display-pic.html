<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Selfie Gallery - Monthly Interaction 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes spotlight {
      0% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0); }
      50% { box-shadow: 0 0 60px 30px rgba(20, 184, 166, 0.9); }
      100% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0); }
    }
    @keyframes shuffle3D {
      0% { transform: rotateY(0deg) translateZ(0px) scale(1); }
      25% { transform: rotateY(60deg) translateZ(30px) scale(1.05); }
      50% { transform: rotateY(120deg) translateZ(-20px) scale(0.95); }
      75% { transform: rotateY(180deg) translateZ(10px) scale(1.03); }
      100% { transform: rotateY(360deg) translateZ(0px) scale(1); }
    }
    @keyframes deckShuffle {
      0% { transform: translateX(0) rotateY(0deg) rotate(0deg); z-index: 1; }
      25% { transform: translateX(-10px) rotateY(-10deg) rotate(-2deg); z-index: 2; }
      50% { transform: translateX(10px) rotateY(10deg) rotate(2deg); z-index: 3; }
      75% { transform: translateX(-5px) rotateY(-5deg) rotate(-1deg); z-index: 2; }
      100% { transform: translateX(0) rotateY(0deg) rotate(0deg); z-index: 1; }
    }

    .deck-shuffle {
      animation: deckShuffle 0.3s ease-in-out infinite;
      transform-origin: center;
    }

    @keyframes flipShuffle {
      0% { transform: rotateY(0deg) translateZ(0); z-index: 1; }
      25% { transform: rotateY(90deg) translateZ(20px); z-index: 3; }
      50% { transform: rotateY(180deg) translateZ(0); z-index: 2; }
      75% { transform: rotateY(270deg) translateZ(-20px); z-index: 3; }
      100% { transform: rotateY(360deg) translateZ(0); z-index: 1; }
    }

    .flip-shuffle {
      animation: flipShuffle 0.8s ease-in-out infinite;
      transform-style: preserve-3d;
    }

    .fade-in { animation: fadeIn 1s ease-out forwards; }
    .fade-out { animation: fadeOut 0.8s ease-in forwards; }
    .winner-pulse { animation: pulse 1s ease-in-out infinite; }
    .spotlight { animation: spotlight 2s ease-in-out infinite; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      background: linear-gradient(to bottom right, #e0f2fe, #cffafe, #ccfbf1);
      overflow: hidden;
    }

    header { height: 96px; }
    main { height: calc(100vh - 96px - 48px); }

    #gallery {
      height: 100%;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 1rem;
      padding: 1rem;
      box-sizing: border-box;
    }

    #gallery.grid-winners {
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem;
      height: calc(100vh - 96px - 48px);
    }

    .card-container {
      perspective: 1000px;
      height: 100%;
      width: 100%;
      border-radius: 1rem;
      overflow: hidden;
      position: relative;
      background: white;
    }

    .card-flipper {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.8s;
      transform-style: preserve-3d;
    }

    .card-container.flipped .card-flipper {
      transform: rotateY(180deg);
    }

    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 1rem;
      overflow: hidden;
    }

    .card-back {
      transform: rotateY(180deg);
      background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
    }

    .photo { width: 100%; height: 100%; object-fit: cover; display: block; }

    .winner-card {
      height: 100%;
      width: 100%;
      border-radius: 1rem;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      background-size: cover;
      background-position: center;
    }

    .winner-caption {
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.45) 100%);
      color: white;
      width: 100%;
      padding: 1rem;
      box-sizing: border-box;
    }

    .nav-tabs {
      display: flex;
      gap: 1rem;
      margin-left: 2rem;
    }

    .nav-tab {
      padding: 0.5rem 1.5rem;
      border-radius: 9999px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .nav-tab:hover {
      transform: scale(1.05);
    }

    .nav-tab.active {
      background: linear-gradient(to right, #0d9488, #14b8a6);
      color: white;
    }

    .nav-tab:not(.active) {
      background: white;
      color: #0d9488;
    }
  </style>
</head>
<body>

  <header class="bg-white/90 backdrop-blur-md shadow-md py-4 px-10 sticky top-0 z-50 flex justify-between items-center">
    <div class="flex items-center">
      <div>
        <div class="inline-block bg-gradient-to-r from-teal-600 to-cyan-500 text-white px-4 py-1 rounded-full text-sm font-semibold mb-1">
          Monthly Interaction 2025
        </div>
        <h1 class="text-4xl font-bold bg-gradient-to-r from-teal-600 to-cyan-600 bg-clip-text text-transparent">
          Selfie Gallery
        </h1>
      </div>

      <nav class="nav-tabs">
        <a href="#slideshow" class="nav-tab" data-page="slideshow">üé¨</a>
        <a href="#winners" class="nav-tab" data-page="winners" style="display: none;">üèÜ</a>
      </nav>
    </div>

    <div class="flex items-center gap-6">
      <!-- Center: Big Crown Button -->
      <button id="pickWinnerBtn" class="bg-gradient-to-r from-yellow-500 via-amber-500 to-yellow-600 text-white px-12 py-4 text-2xl rounded-full shadow-2xl hover:scale-110 transition-all font-bold">
        üëë Crown the Selfie Queen üëë
      </button>

      <!-- Right: Other buttons and count -->
      <div class="flex items-center gap-3">
        <div class="text-right">
          <div class="text-3xl font-bold text-teal-600" id="photoCount">0</div>
          <div class="text-xs text-gray-500 mt-1"><span id="currentBatch">1-8</span></div>
        </div>
        <button id="resetWinnersBtn" class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-4 py-2 text-sm rounded-full shadow-lg hover:scale-105 transition">
          üîÑ
        </button>
      </div>
    </div>
  </header>

  <main><div id="gallery"></div></main>

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-white/90 flex items-center justify-center z-50">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-teal-200 border-t-teal-600 mb-4"></div>
      <p class="text-gray-800 text-xl">Loading selfies...</p>
    </div>
  </div>

  <div id="empty" class="hidden fixed inset-0 flex items-center justify-center">
    <div class="text-center">
      <div class="text-7xl mb-4">üì∏</div>
      <p class="text-gray-800 text-2xl font-bold">No selfies yet</p>
    </div>
  </div>

  <!-- Winner Overlay -->
  <div id="winnerOverlay" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[100]">
    <div class="bg-gradient-to-br from-white to-teal-100 rounded-3xl p-10 text-center max-w-2xl shadow-2xl spotlight">
      <div class="text-8xl mb-4 animate-bounce">üèÜ</div>
      <h2 id="winnerName" class="text-6xl font-bold text-teal-700 mb-3"></h2>
      <p id="winnerUnit" class="text-3xl text-gray-700 mb-6"></p>
      <p class="text-2xl text-teal-600 font-semibold mb-8">üéâ Congratulations! üéâ</p>
      <div id="winnerPhoto" class="mb-6 flex justify-center">
        <img id="winnerImg" src="" class="max-w-md max-h-96 rounded-2xl shadow-2xl object-cover" />
      </div>
    </div>
  </div>

  <footer class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md py-2 text-center text-sm text-gray-600 shadow">
    Made with ‚ù§Ô∏è by Ordnance Fraternity ‚Ä¢ <span id="footerText">Rotating every 15 seconds</span>
  </footer>

  <script>
    const SUPABASE_URL = "https://jlzqdefinnwoazsqlunf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsenFkZWZpbm53b2F6c3FsdW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTgwOTksImV4cCI6MjA3ODAzNDA5OX0.ZPfFVDqJgZkuhPGO9WNlYHKDwKgQ9SZoGjSIypgaDIE";
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const gallery = document.getElementById("gallery");
    const loading = document.getElementById("loading");
    const empty = document.getElementById("empty");
    const photoCount = document.getElementById("photoCount");
    const currentBatch = document.getElementById("currentBatch");
    const pickWinnerBtn = document.getElementById("pickWinnerBtn");
    const resetWinnersBtn = document.getElementById("resetWinnersBtn");
    const footerText = document.getElementById("footerText");
    const winnerOverlay = document.getElementById("winnerOverlay");
    const winnerName = document.getElementById("winnerName");
    const winnerUnit = document.getElementById("winnerUnit");
    const winnerImg = document.getElementById("winnerImg");

    let allPhotos = [];
    let currentIndex = 0;
    const PHOTOS_PER_SLIDE = 8;
    const TRANSITION_TIME = 15000;
    let selectionInProgress = false;
    let slideInterval = null;
    let currentView = 'slideshow';
    let displayedBatch = [];

    function esc(s) {
      if (!s) return '';
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    }

    function createCardMarkup(p) {
      const isWinner = p.is_winner === true; // Explicitly check for true
      return `
        <div class="card-container" data-id="${p.id}" data-url="${esc(p.selfie_url)}" data-iswinner="${isWinner ? 'true' : 'false'}">
          <div class="card-flipper">
            <div class="card-front bg-white/80 backdrop-blur-lg shadow-xl flex flex-col">
              <div class="flex-1 overflow-hidden relative">
                ${p.selfie_url ? `<img src="${esc(p.selfie_url)}" alt="${esc(p.name)}" class="photo" />`
                  : `<div class='flex items-center justify-center h-full bg-teal-100'><span class='text-6xl'>üë§</span></div>`}
                ${isWinner ? '<div class="absolute top-2 left-2 bg-yellow-500 text-white px-2 py-1 rounded text-xs font-bold">üèÜ WON</div>' : ''}
              </div>
              <div class="p-3 text-center bg-gradient-to-br from-white to-teal-50">
                <h3 class="font-bold text-base text-gray-800 truncate">${esc(p.name)}</h3>
                <p class="text-xs text-gray-600 truncate">${esc(p.unit || 'Unit not specified')}</p>
              </div>
            </div>
            <div class="card-back">
              <span>‚ùì</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderBatch(batch) {
      displayedBatch = batch.slice();
      gallery.className = '';
      gallery.style.gridTemplateColumns = 'repeat(4, 1fr)';
      gallery.style.gridTemplateRows = 'repeat(2, 1fr)';
      gallery.style.justifyContent = '';
      gallery.style.alignItems = '';
      gallery.innerHTML = batch.map(p => createCardMarkup(p)).join('');
      document.querySelectorAll('.card-container').forEach(c => {
        c.classList.remove('flipped', 'spotlight', 'winner-pulse');
      });
    }

    function showSlide() {
      if (!allPhotos.length || selectionInProgress || currentView !== 'slideshow') return;
      
      const batch = [];
      let idx = currentIndex;
      
      // Handle edge case: fewer photos than PHOTOS_PER_SLIDE
      const photosToShow = Math.min(PHOTOS_PER_SLIDE, allPhotos.length);
      
      for (let i = 0; i < photosToShow; i++) {
        batch.push(allPhotos[idx % allPhotos.length]);
        idx++;
      }
      
      currentIndex = idx % allPhotos.length;
      
      gallery.classList.add('fade-out');
      setTimeout(() => {
        gallery.classList.remove('fade-out');
        renderBatch(batch);
        gallery.classList.add('fade-in');
        const start = ((currentIndex - photosToShow + allPhotos.length) % allPhotos.length) + 1;
        currentBatch.textContent = `${start}-${Math.min(start + photosToShow - 1, allPhotos.length)} of ${allPhotos.length}`;
        setTimeout(() => gallery.classList.remove('fade-in'), 1000);
      }, 700);
    }

    async function showWinnersView() {
      const { data: winners } = await supabase
        .from('participants')
        .select('*')
        .eq('is_winner', true)
        .not('selfie_url', 'is', null)
        .order('created_at', { ascending: false });

      if (!winners || !winners.length) {
        alert('No winners yet.');
        window.location.hash = '#slideshow';
        return;
      }

      currentView = 'winners';
      if (slideInterval) clearInterval(slideInterval);

      gallery.classList.add('fade-out');
      setTimeout(() => {
        gallery.className = 'grid-winners';
        const topThree = winners.slice(0, 3);
        
        // Dynamic grid columns based on number of winners
        if (topThree.length === 1) {
          gallery.style.gridTemplateColumns = '1fr';
          gallery.style.justifyContent = 'center';
          gallery.style.alignItems = 'center';
        } else if (topThree.length === 2) {
          gallery.style.gridTemplateColumns = 'repeat(2, 1fr)';
        } else {
          gallery.style.gridTemplateColumns = 'repeat(3, 1fr)';
        }
        gallery.style.gridTemplateRows = '1fr';
        
        gallery.innerHTML = topThree.map(w => {
          const url = esc(w.selfie_url);
          return `
            <div class="winner-card" data-id="${w.id}" style="background-image: url('${url}');">
              <div class="winner-caption">
                <div class="text-2xl font-semibold">${esc(w.name)}</div>
                <div class="text-sm">${esc(w.unit || '')}</div>
              </div>
            </div>
          `;
        }).join('');
        gallery.classList.remove('fade-out');
        gallery.classList.add('fade-in');
        currentBatch.textContent = `${winners.length} Winner${winners.length > 1 ? 's' : ''}`;
        footerText.textContent = 'Winner Display Mode';
        setTimeout(() => gallery.classList.remove('fade-in'), 1000);
      }, 600);
    }

    function showSlideshowView() {
      currentView = 'slideshow';
      footerText.textContent = 'Rotating every 15 seconds';
      if (slideInterval) clearInterval(slideInterval);
      loadSelfies();
    }

    async function loadSelfies() {
      try {
        const { data, error } = await supabase
          .from('participants')
          .select('id, name, unit, selfie_url, is_winner, created_at')
          .not('selfie_url', 'is', null)
          .order('created_at', { ascending: false });

        if (error) throw error;
        if (!data || !data.length) {
          loading.classList.add('hidden');
          empty.classList.remove('hidden');
          photoCount.textContent = '0';
          return;
        }

        allPhotos = data;
        photoCount.textContent = data.length;
        loading.classList.add('hidden');
        empty.classList.add('hidden');

        // Update navigation visibility
        updateNavigation();

        if (currentView === 'slideshow') {
          currentIndex = currentIndex % allPhotos.length;
          showSlide();
          if (slideInterval) clearInterval(slideInterval);
          slideInterval = setInterval(showSlide, TRANSITION_TIME);
        }
      } catch (err) {
        console.error('Error:', err);
        loading.classList.add('hidden');
        empty.classList.add('hidden');
      }
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    async function pickWinners() {
      if (!allPhotos.length) return alert('No selfies available!');
      if (selectionInProgress) return;
      
      selectionInProgress = true;
      if (slideInterval) clearInterval(slideInterval);
      footerText.textContent = "Crowning the Selfie Queen...";

      const candidates = allPhotos.filter(p => p.is_winner !== true); // Only those NOT true
      if (!candidates.length) {
        alert('All participants have been crowned! Please reset to continue.');
        selectionInProgress = false;
        slideInterval = setInterval(showSlide, TRANSITION_TIME);
        footerText.textContent = "Rotating every 15 seconds";
        return;
      }

      // Pick only ONE winner per click
      const winner = candidates[Math.floor(Math.random() * candidates.length)];

      // Ensure we have a proper batch displayed
      if (!displayedBatch || displayedBatch.length < PHOTOS_PER_SLIDE) {
        const batch = [];
        let idx = currentIndex;
        for (let i = 0; i < PHOTOS_PER_SLIDE; i++) {
          batch.push(allPhotos[idx % allPhotos.length]);
          idx++;
        }
        renderBatch(batch);
        await new Promise(r => setTimeout(r, 80));
      }

      const cardNodes = [...document.querySelectorAll('.card-container')];
      cardNodes.forEach(c => c.classList.add('flipped'));
      cardNodes.forEach((card, i) => {
        card.classList.add('deck-shuffle', 'flip-shuffle');
        card.style.willChange = 'transform, opacity';
        card.style.zIndex = 100 - i;
      });

      const pool = shuffleArray(candidates);
      const TOTAL_TICKS = 60;
      const finalSlotIndex = Math.floor(Math.random() * Math.min(cardNodes.length, PHOTOS_PER_SLIDE));
      
      for (let tick = 0; tick < TOTAL_TICKS; tick++) {
        const t = tick / TOTAL_TICKS;
        const minDelay = 20;
        const maxDelay = 240;
        const delay = Math.round(minDelay + (maxDelay - minDelay) * (t * t));

        cardNodes.forEach((card, idx) => {
          const imgEl = card.querySelector('.photo');
          const caption = card.querySelector('.p-3');
          const wonBadge = card.querySelector('.absolute.top-2');
          let chosen;
          if (tick === TOTAL_TICKS - 1 && idx === finalSlotIndex) {
            chosen = winner;
          } else {
            chosen = pool[Math.floor(Math.random() * pool.length)] || candidates[Math.floor(Math.random() * candidates.length)];
          }
          if (imgEl) {
            if (chosen && chosen.selfie_url) imgEl.src = chosen.selfie_url;
            else imgEl.src = '';
          }
          card.dataset.id = chosen ? chosen.id : '';
          card.dataset.iswinner = (chosen && chosen.is_winner === true) ? 'true' : 'false';
          
          // Update WON badge
          if (wonBadge) {
            wonBadge.style.display = (chosen && chosen.is_winner === true) ? 'block' : 'none';
          }
          
          if (caption) {
            const title = caption.querySelector('h3');
            const sub = caption.querySelector('p');
            if (title) title.textContent = chosen ? (chosen.name || '') : '';
            if (sub) sub.textContent = chosen ? (chosen.unit || '') : '';
          }
        });

        document.querySelectorAll('.card-container').forEach(c => c.classList.remove('winner-pulse'));
        const pulseCard = cardNodes[tick % cardNodes.length];
        if (pulseCard) pulseCard.classList.add('winner-pulse');

        await new Promise(r => setTimeout(r, delay));
      }

      cardNodes.forEach(c => {
        c.classList.remove('deck-shuffle', 'flip-shuffle', 'winner-pulse');
        c.style.willChange = '';
        c.style.zIndex = '';
      });

      const finalCard = cardNodes[finalSlotIndex];
      if (finalCard) {
        finalCard.classList.add('spotlight');
        finalCard.classList.remove('flipped');
      }

      await new Promise(r => setTimeout(r, 700));

      if (window.confetti) {
        confetti({ particleCount: 170, spread: 70, origin: { y: 0.55 } });
        setTimeout(() => {
          confetti({ particleCount: 90, angle: 60, spread: 55, origin: { x: 0 } });
          confetti({ particleCount: 90, angle: 120, spread: 55, origin: { x: 1 } });
        }, 300);
      }

      winnerName.textContent = winner.name;
      winnerUnit.textContent = winner.unit || '';
      winnerImg.src = winner.selfie_url;
      winnerOverlay.classList.remove('hidden');

      try {
        const audio = new Audio('https://cdn.pixabay.com/download/audio/2021/08/04/audio_2d96c6f3f6.mp3?filename=success-1-6297.mp3');
        audio.volume = 0.5;
        audio.play().catch(() => {});
      } catch (e) {}

      try {
        await supabase.from('participants').update({ is_winner: true }).eq('id', winner.id);
      } catch (e) {
        console.error('DB update failed', e);
      }

      const idxLocal = allPhotos.findIndex(p => p.id === winner.id);
      if (idxLocal !== -1) allPhotos[idxLocal].is_winner = true;

      await new Promise(r => setTimeout(r, 2500));
      winnerOverlay.classList.add('hidden');
      document.querySelectorAll('.card-container').forEach(c => c.classList.remove('spotlight'));

      footerText.textContent = "Queen crowned!";
      
      selectionInProgress = false;
      
      // Reload data from database and go to winners view
      await loadSelfies();
      window.location.hash = '#winners';
      
      // Ensure the gallery is restored to proper state after winner selection
      if (currentView === 'slideshow') {
        showSlide();
      }
    }

    function waitForSpacebar() {
      return new Promise(resolve => {
        const listener = (e) => {
          if (e.code === 'Space') {
            e.preventDefault();
            document.removeEventListener('keydown', listener, false);
            resolve();
          }
        };
        document.addEventListener('keydown', listener, false);
      });
    }

    async function resetWinners() {
      const confirmed = confirm('Are you sure you want to reset all winners? This will clear all winner selections.');
      if (!confirmed) return;

      try {
        footerText.textContent = "Resetting winners...";
        
        // Update all participants to not be winners
        const { error } = await supabase
          .from('participants')
          .update({ is_winner: false })
          .eq('is_winner', true);

        if (error) throw error;

        // Update local data
        allPhotos.forEach(p => p.is_winner = false);

        alert('All winners have been reset!');
        
        // Return to slideshow view
        window.location.hash = '#slideshow';
        await loadSelfies();
        
      } catch (err) {
        console.error('Reset error:', err);
        alert('Failed to reset winners. Please try again.');
        footerText.textContent = "Reset failed";
      }
    }

    function updateNavigation() {
      // Show/hide winners tab based on whether there are any winners (explicitly true)
      const hasWinners = allPhotos.some(p => p.is_winner === true);
      const winnersTab = document.querySelector('[data-page="winners"]');
      if (winnersTab) {
        winnersTab.style.display = hasWinners ? 'block' : 'none';
      }
    }

    // Hash navigation
    function handleHashChange() {
      const hash = window.location.hash.slice(1) || 'slideshow';
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.page === hash);
      });

      if (hash === 'winners') {
        showWinnersView();
      } else {
        showSlideshowView();
      }
    }

    pickWinnerBtn.addEventListener('click', pickWinners);
    resetWinnersBtn.addEventListener('click', resetWinners);
    window.addEventListener('hashchange', handleHashChange);
    window.addEventListener('load', handleHashChange);
    window.addEventListener('resize', () => {
      if (currentView === 'winners') showWinnersView();
    });

    // Realtime subscription for multi-screen sync
    const realtimeChannel = supabase
      .channel('winner-updates')
      .on('postgres_changes', { 
        event: 'UPDATE', 
        schema: 'public', 
        table: 'participants',
        filter: 'is_winner=eq.true'
      }, () => {
        console.log('Winner update detected, reloading...');
        loadSelfies();
      })
      .subscribe();

    // Initial load
    if (!window.location.hash) {
      window.location.hash = '#slideshow';
    } else {
      handleHashChange();
    }
  </script>
</body>
</html>