<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Selfie Gallery - Ladies Meet 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: scale(1); }
      to { opacity: 0; transform: scale(0.95); }
    }
    .fade-in { animation: fadeIn 1s ease-out forwards; }
    .fade-out { animation: fadeOut 0.8s ease-in forwards; }
    .grid-item { transition: all 0.8s ease-in-out; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: linear-gradient(to bottom right, #ffe4e6, #fce7f3, #f3e8ff);
    }

    /* Perfect 4x2 grid filling screen neatly */
    #gallery {
      height: calc(100vh - 160px);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 1rem;
      padding: 1rem;
      box-sizing: border-box;
    }

    /* Portrait style photos */
    .photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      aspect-ratio: 3 / 4;
    }
  </style>
</head>
<body class="overflow-hidden">

  <!-- Header -->
  <header class="bg-white/90 backdrop-blur-md shadow-md py-4 px-10 sticky top-0 z-50">
    <div class="max-w-[1920px] mx-auto flex justify-between items-center">
      <div>
        <div class="inline-block bg-gradient-to-r from-rose-500 to-pink-500 text-white px-4 py-1 rounded-full text-sm font-semibold mb-1">
          Ladies Meet 2025
        </div>
        <h1 class="text-4xl font-bold bg-gradient-to-r from-rose-600 to-pink-600 bg-clip-text text-transparent">
          Selfie Gallery
        </h1>
      </div>
      <div class="text-right">
        <div class="text-3xl font-bold text-rose-600" id="photoCount">0</div>
        <div class="text-sm text-gray-600">Future Ready Faces</div>
        <div class="text-xs text-gray-500 mt-1">Showing <span id="currentBatch">1-8</span></div>
      </div>
    </div>
  </header>

  <!-- Gallery -->
  <main>
    <div id="gallery"></div>
  </main>

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-white/90 flex items-center justify-center z-50">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-rose-200 border-t-rose-600 mb-4"></div>
      <p class="text-gray-800 text-xl">Loading selfies...</p>
    </div>
  </div>

  <!-- Empty -->
  <div id="empty" class="hidden fixed inset-0 flex items-center justify-center bg-gradient-to-br from-rose-100 via-pink-50 to-purple-100">
    <div class="text-center">
      <div class="text-7xl mb-4">üì∏</div>
      <p class="text-gray-800 text-2xl font-bold mb-2">No selfies yet</p>
      <p class="text-gray-600 text-lg">Check back soon!</p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md py-2 text-center text-sm text-gray-600 shadow">
    Made with ‚ù§Ô∏è by Ordnance Fraternity ‚Ä¢ Rotating every 15 seconds
  </footer>

  <script>
    const SUPABASE_URL = "https://jlzqdefinnwoazsqlunf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsenFkZWZpbm53b2F6c3FsdW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTgwOTksImV4cCI6MjA3ODAzNDA5OX0.ZPfFVDqJgZkuhPGO9WNlYHKDwKgQ9SZoGjSIypgaDIE";
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const gallery = document.getElementById("gallery");
    const loading = document.getElementById("loading");
    const empty = document.getElementById("empty");
    const photoCount = document.getElementById("photoCount");
    const currentBatch = document.getElementById("currentBatch");

    let allPhotos = [];
    let currentIndex = 0;
    const PHOTOS_PER_SLIDE = 8;
    const TRANSITION_TIME = 15000;

    function escapeHtml(s) {
      if (s == null) return "";
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function createCard(p) {
      return `
        <div class="grid-item bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col">
          <div class="flex-1 bg-gray-100 overflow-hidden">
            ${p.selfie_url ? `
              <img src="${escapeHtml(p.selfie_url)}"
                alt="${escapeHtml(p.name)}"
                class="photo"
                onerror="this.parentElement.innerHTML='<div class=\'flex items-center justify-center h-full bg-rose-100\'><span class=\'text-6xl\'>üë§</span></div>'" />
            ` : `
              <div class="flex items-center justify-center h-full bg-rose-100">
                <span class="text-6xl">üë§</span>
              </div>
            `}
          </div>
          <div class="p-3 text-center bg-gradient-to-t from-rose-50 to-white">
            <h3 class="font-bold text-lg text-gray-800 truncate">${escapeHtml(p.name)}</h3>
            <p class="text-sm text-gray-600 truncate">${escapeHtml(p.unit || "Unit not specified")}</p>
          </div>
        </div>
      `;
    }

    function showSlide() {
      if (!allPhotos || allPhotos.length === 0) return;
      const batch = [];
      for (let i = 0; i < PHOTOS_PER_SLIDE; i++) {
        batch.push(allPhotos[currentIndex]);
        currentIndex = (currentIndex + 1) % allPhotos.length;
      }
      gallery.classList.add("fade-out");
      setTimeout(() => {
        gallery.innerHTML = batch.map(p => createCard(p)).join("");
        gallery.classList.remove("fade-out");
        gallery.classList.add("fade-in");
        const start = ((currentIndex - PHOTOS_PER_SLIDE + allPhotos.length) % allPhotos.length) + 1;
        const end = start + PHOTOS_PER_SLIDE - 1;
        currentBatch.textContent = `${start}-${Math.min(end, allPhotos.length)} of ${allPhotos.length}`;
        setTimeout(() => gallery.classList.remove("fade-in"), 1000);
      }, 800);
    }

    async function loadSelfies() {
      try {
        const { data, error } = await supabase
          .from("participants")
          .select("name, unit, selfie_url, created_at")
          .not("selfie_url", "is", null)
          .order("created_at", { ascending: false });
        if (error) throw error;

        if (!data || data.length === 0) {
          loading.classList.add("hidden");
          empty.classList.remove("hidden");
          photoCount.textContent = "0";
          return;
        }
        allPhotos = data;
        photoCount.textContent = data.length;
        loading.classList.add("hidden");
        empty.classList.add("hidden");
        showSlide();
        setInterval(showSlide, TRANSITION_TIME);
      } catch (err) {
        console.error("Error loading selfies:", err);
        loading.classList.add("hidden");
        empty.classList.remove("hidden");
      }
    }

    loadSelfies();
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden && allPhotos.length > 0) showSlide();
    });
  </script>
</body>
</html>
